<?xml version="1.0" encoding="UTF-8"?>
<project name="VCS tagging">
    
  <condition property="output" value="NUL" else="/dev/null">
    <os family="windows" />        
  </condition>

  <target name="-diff2head" depends="integration-test">
    <echo message="- diff to head ---------------------------------------------------"/>
    <antcall target="git.diff" />
    <antcall target="svn.diff" />
  </target>

  <target name="-version-number-infer" depends="-diff2head">
    <echo message="- version number infer -------------------------------------------"/>
    <loadfile property="composer.json" srcFile="composer.json" failonerror="false"/>
    <script language="javascript">
      var config = eval("(" + project.getProperty("composer.json") + ")");
      project.setProperty("dev-version", config["version"]);
      var version = config["version"].replaceAll("^(([0-9]{1,2}.)+([0-9]{1,2}))(.*)$", "$1");
      project.setProperty("version", version);
    </script>
    <echo message="The version nummber is: ${version}" />
  </target>

  <target name="-version-exist" depends="-version-number-infer">
    <echo message="- version exist --------------------------------------------------"/>
    <antcall target="git.info" />
    <antcall target="svn.info" />
  </target>
  
  <target name="-version-number-update" depends="-version-exist">
    <echo message="- version number increment -----------------------------------------"/>
    <script language="javascript">
      var config = project.getProperty("composer.json");
      config = config.replaceAll('"version"([ ]*):([ ]*)"'+project.getProperty("dev-version")+'",', '"version" : "' + project.getProperty("version")  + '",');      
      project.setProperty("composer.json", config);
    </script>
    <echo file="composer.json" message="${composer.json}"/>      
    <echo message="Update the composer.json to ${version} version ."/>      
  </target>  

  <target name="-version-create" depends="-version-number-update">
    <echo message="- version create --------------------------------------------------"/>
    <antcall target="git.copy" />
    <antcall target="svn.copy" />
  </target>

  <target name="-version-number-increment" depends="-version-create">
    <echo message="- version number increment -----------------------------------------"/>
    <script language="javascript">
      var numbers = project.getProperty("version").split(".");
      number = numbers.pop();
      numbers.push(++number);
      var version = numbers.join(".") + "-dev";
      var config = project.getProperty("composer.json");
      config = config.replaceAll('"version"([ ]*):([ ]*)"'+project.getProperty("version")+'",', '"version" : "' + version  + '",');      
      project.setProperty("composer.json", config);
      project.setProperty("dev-version", version);
    </script>
    <echo file="composer.json" message="${composer.json}"/>      
    <echo message="Update the composer.json to ${dev-version} version ."/>      
  </target>  

  <target name="-config-commit" depends="-version-number-increment">
    <echo message="- config commit ----------------------------------------------------"/>
    <antcall target="git.commit" />
    <antcall target="svn.commit" />
  </target>

  <target name="-vcs-type">
    <condition property="vcsgit">
      <matches string="${scm}" pattern="^(.+)\.git$"/>
    </condition>
  </target>

  <include file="svn.xml" />
  <include file="git.xml" />

  <target name="tagging" depends="-vcs-type,-config-commit" />

</project>
